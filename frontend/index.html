<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>音声アップロード＆波形表示</title>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <style>
    #waveform {
      width: 100%;
      height: 100px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h2>🎙️ 音声ファイルをアップロードして波形を表示</h2>

  <input type="file" id="audioInput" accept="audio/*">
  <button id="uploadBtn">📤 アップロード</button>
  <button id="playBtn" disabled>▶️ 再生</button>

  <div id="waveform"></div>

  <script>
    const wavesurfer = WaveSurfer.create({
      container: '#waveform',
      waveColor: '#ddd',
      progressColor: '#00aaff',
      height: 100,
      responsive: true,
    });

    wavesurfer.on('ready', () => {
      const duration = wavesurfer.getDuration();
      document.getElementById('totalDuration').textContent = duration.toFixed(2);
    });

    wavesurfer.on('audioprocess', () => {
      const time = wavesurfer.getCurrentTime();
      document.getElementById('currentTime').textContent = time.toFixed(2);
    });

    wavesurfer.on('interaction', () => {
      const time = wavesurfer.getCurrentTime();
      document.getElementById('currentTime').textContent = time.toFixed(2);
    });

    wavesurfer.on('seek', () => {
      const time = wavesurfer.getCurrentTime();
      document.getElementById('currentTime').textContent = time.toFixed(2);
    });

    wavesurfer.on('finish', () => {
      wavesurfer.seekTo(0);  // ← 再生位置を先頭に戻す！
      document.getElementById('currentTime').textContent = "0.00";
    });

    const audioInput = document.getElementById('audioInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const playBtn = document.getElementById('playBtn');

    uploadBtn.addEventListener('click', async () => {
      const file = audioInput.files[0];
      if (!file) {
        alert("ファイルを選んでください！");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      const res = await fetch("http://localhost:8000/upload/", {
        method: "POST",
        body: formData,
      });

      const json = await res.json();
      document.getElementById('transcriptionText').textContent = json.transcription;

      console.log("アップロード結果:", json);

      const audioUrl = `http://localhost:8000/temp_audio/${json.filename}`;
      wavesurfer.load(audioUrl);
      playBtn.disabled = false;


    });

    playBtn.addEventListener('click', () => {
      wavesurfer.playPause();
    });
  </script>
  <div>
    <span>再生位置: <span id="currentTime">0.00</span> 秒</span> |
    <span>全体長さ: <span id="totalDuration">--</span> 秒</span>
  </div>
  <p>📝 文字起こし: <span id="transcriptionText">--</span></p>


</body>

</html>